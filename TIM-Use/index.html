<!DOCTYPE html>
<html lang="en">
    <head>
        <meta charset="utf-8">
        <meta http-equiv="X-UA-Compatible" content="IE=edge">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        
        <meta name="author" content="ASR-Crash">
        
        <link rel="shortcut icon" href="../favicon.ico">
        
        <title>TIM - 厦门大学·RoboMaster·软件标准化</title>
        <link href="../css/bootstrap.min.css" rel="stylesheet">
        <link href="../css/font-awesome.min.css" rel="stylesheet">
        <link href="../css/base.css" rel="stylesheet">
        <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/10.5.0/styles/github.min.css">

        <script src="../js/jquery-1.10.2.min.js" defer></script>
        <script src="../js/bootstrap.min.js" defer></script>
        <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/10.5.0/highlight.min.js"></script>
        <script>hljs.initHighlightingOnLoad();</script> 
    </head>

    <body>
        <div class="navbar fixed-top navbar-expand-lg navbar-dark bg-primary">
            <div class="container">
                <a class="navbar-brand" href="..">厦门大学·RoboMaster·软件标准化</a>
                <!-- Expander button -->
                <button type="button" class="navbar-toggler" data-toggle="collapse" data-target="#navbar-collapse">
                    <span class="navbar-toggler-icon"></span>
                </button>

                <!-- Expanded navigation -->
                <div id="navbar-collapse" class="navbar-collapse collapse">
                        <!-- Main navigation -->
                        <ul class="nav navbar-nav">
                            <li class="dropdown">
                                <a href="#" class="nav-link dropdown-toggle" data-toggle="dropdown">Overview <b class="caret"></b></a>
                                <ul class="dropdown-menu">
                                    
<li>
    <a href="../Introduction/" class="dropdown-item">Introduction</a>
</li>
                                    
<li>
    <a href="../Hardware-Support/" class="dropdown-item">Hardware Support</a>
</li>
                                </ul>
                            </li>
                            <li class="dropdown active">
                                <a href="#" class="nav-link dropdown-toggle" data-toggle="dropdown">Beginners <b class="caret"></b></a>
                                <ul class="dropdown-menu">
                                    
<li>
    <a href="../Software-Install/" class="dropdown-item">Software Install</a>
</li>
                                    
<li>
    <a href="../Getting-Started/" class="dropdown-item">Getting Started</a>
</li>
                                    
<li>
    <a href="./" class="dropdown-item active">TIM</a>
</li>
                                    
<li>
    <a href="../USART-Use/" class="dropdown-item">USART</a>
</li>
                                    
<li>
    <a href="../CAN-Use/" class="dropdown-item">CAN</a>
</li>
                                </ul>
                            </li>
                            <li class="dropdown">
                                <a href="#" class="nav-link dropdown-toggle" data-toggle="dropdown">Algorithms <b class="caret"></b></a>
                                <ul class="dropdown-menu">
                                    
<li>
    <a href="../Motor-Control/" class="dropdown-item">Motor Control</a>
</li>
                                </ul>
                            </li>
                            <li class="dropdown">
                                <a href="#" class="nav-link dropdown-toggle" data-toggle="dropdown">Livox Mid-70 <b class="caret"></b></a>
                                <ul class="dropdown-menu">
                                    
<li>
    <a href="../Livox-Mid70-Guidance/" class="dropdown-item">Development Guide</a>
</li>
                                </ul>
                            </li>
                            <li class="dropdown">
                                <a href="#" class="nav-link dropdown-toggle" data-toggle="dropdown">References <b class="caret"></b></a>
                                <ul class="dropdown-menu">
                                    
<li>
    <a href="../Motor-Parameters/" class="dropdown-item">Motor Parameters</a>
</li>
                                </ul>
                            </li>
                            <li class="dropdown">
                                <a href="#" class="nav-link dropdown-toggle" data-toggle="dropdown">FAQs <b class="caret"></b></a>
                                <ul class="dropdown-menu">
                                    
<li>
    <a href="../How-to-Debug/" class="dropdown-item">How to Debug</a>
</li>
                                </ul>
                            </li>
                        </ul>

                    <ul class="nav navbar-nav ml-auto">
                        <li class="nav-item">
                            <a href="#" class="nav-link" data-toggle="modal" data-target="#mkdocs_search_modal">
                                <i class="fa fa-search"></i> Search
                            </a>
                        </li>
                            <li class="nav-item">
                                <a rel="prev" href="../Getting-Started/" class="nav-link">
                                    <i class="fa fa-arrow-left"></i> Previous
                                </a>
                            </li>
                            <li class="nav-item">
                                <a rel="next" href="../USART-Use/" class="nav-link">
                                    Next <i class="fa fa-arrow-right"></i>
                                </a>
                            </li>
                    </ul>
                </div>
            </div>
        </div>

        <div class="container">
            <div class="row">
                    <div class="col-md-3"><div class="navbar-light navbar-expand-md bs-sidebar hidden-print affix" role="complementary">
    <div class="navbar-header">
        <button type="button" class="navbar-toggler collapsed" data-toggle="collapse" data-target="#toc-collapse" title="Table of Contents">
            <span class="fa fa-angle-down"></span>
        </button>
    </div>

    
    <div id="toc-collapse" class="navbar-collapse collapse card bg-secondary">
        <ul class="nav flex-column">
            
            <li class="nav-item" data-level="1"><a href="#timhtimcpp" class="nav-link">tim.h和tim.cpp文件的使用</a>
              <ul class="nav flex-column">
            <li class="nav-item" data-level="2"><a href="#timh" class="nav-link">tim.h</a>
              <ul class="nav flex-column">
              </ul>
            </li>
            <li class="nav-item" data-level="2"><a href="#timcpp" class="nav-link">tim.cpp</a>
              <ul class="nav flex-column">
              </ul>
            </li>
              </ul>
            </li>
        </ul>
    </div>
</div></div>
                    <div class="col-md-9" role="main">

<p>定时器 (Timer) 最基本的功能就是定时了，比如定时发送 USART 数据、定时采集 AD 数据等等。 如果把定时器与 GPIO 结合起来使用的话可以实现非常丰富的功能，可以测量输入信号的脉冲宽 度，可以生产输出波形。定时器生产 PWM 控制电机状态是工业控制普遍方法，这方面知识非常 有必要深入了解。</p>
<h1 id="timhtimcpp">tim.h和tim.cpp文件的使用</h1>
<h2 id="timh">tim.h</h2>
<pre><code class="language-c++">#pragma once
#include &quot;stm32f4xx_hal.h&quot;
#include &quot;functional&quot;
#include &quot;gpio.h&quot;
enum{ BASE, PWM, IC };

class TIM
{
    public:
    TIM&amp; Init(uint32_t Mode, TIM_TypeDef* TIM, uint32_t frequency);
    void MspPostInit(reuse r) const;
    void BaseInit(void);
    TIM&amp; PWMInit(uint32_t channel, float duty, reuse r);
    void PWMDuty(uint32_t channel, float duty) const;
    void ICInit(int32_t channel, uint32_t ICPolarity, reuse r);

    bool operator==(const TIM_HandleTypeDef *htim)
    {
        return (&amp;this-&gt;htim) == htim;
    }
    TIM_HandleTypeDef htim;
    uint32_t counter;
};

extern TIM tasks, fraction, photogate;
</code></pre>
<h2 id="timcpp">tim.cpp</h2>
<pre><code class="language-c++">#include &quot;tim.h&quot;
#include &quot;can.h&quot;
#include &quot;IMU.h&quot;
#include &quot;motor.h&quot;
#include &quot;control.h&quot;
#include &quot;RC.h&quot;
#include &quot;LED.h&quot;
#include &quot;judgement.h&quot;
#include &quot;powerlimit.h&quot;

TIM_HandleTypeDef *phtim[4];

TIM&amp; TIM::Init(const uint32_t Mode, TIM_TypeDef* TIM, const uint32_t frequency)
{
    const float x = 84000000 / frequency;
    if (x &gt;= 5000)
    {
        htim.Init.Prescaler = x / 5000 - 1u;
        htim.Init.Period = 5000 - 1u;
    }
    else
    {
        htim.Init.Prescaler = 84u - 1u;
        htim.Init.Period = x / 84 - 1u;
    }
    htim.Instance = TIM;
    htim.Init.CounterMode = TIM_COUNTERMODE_UP;
    htim.Init.ClockDivision = TIM_CLOCKDIVISION_DIV1;
    switch (Mode)
    {
        case BASE:HAL_TIM_Base_Init(&amp;htim); break;
        case PWM:HAL_TIM_PWM_Init(&amp;htim); break;
        case IC:HAL_TIM_IC_Init(&amp;htim); break;
        default:;
    }
    if (TIM == TIM2)phtim[1] = &amp;htim;
    if (TIM == TIM3)phtim[2] = &amp;htim;
    if (TIM == TIM4)phtim[3] = &amp;htim;
    return *this;
}
void TIM::MspPostInit(const reuse r) const
{
    GPIO_InitTypeDef GPIO_InitStruct;
    GPIO_CLK_ENABLE(r.GPIOx);

    GPIO_InitStruct.Pin = r.Pin;
    GPIO_InitStruct.Mode = GPIO_MODE_AF_PP;
    GPIO_InitStruct.Pull = GPIO_NOPULL;
    GPIO_InitStruct.Speed = GPIO_SPEED_FREQ_LOW;
    GPIO_InitStruct.Alternate = this-&gt;htim.Instance == TIM2 ? GPIO_AF1_TIM2 : GPIO_AF2_TIM3;
    HAL_GPIO_Init(r.GPIOx, &amp;GPIO_InitStruct);
}

extern &quot;C&quot; void TIM2_IRQHandler(void)
{
    if (phtim[1])HAL_TIM_IRQHandler(phtim[1]);
}
extern &quot;C&quot; void TIM3_IRQHandler(void)
{
    if (phtim[2])HAL_TIM_IRQHandler(phtim[2]);
}
extern &quot;C&quot; void TIM4_IRQHandler(void)
{
    if (phtim[3])HAL_TIM_IRQHandler(phtim[3]);
}

void TIM::BaseInit(void)
{
    TIM_ClockConfigTypeDef sClockSourceConfig;
    TIM_MasterConfigTypeDef sMasterConfig;

    sClockSourceConfig.ClockSource = TIM_CLOCKSOURCE_INTERNAL;
    HAL_TIM_ConfigClockSource(&amp;htim, &amp;sClockSourceConfig);

    sMasterConfig.MasterOutputTrigger = TIM_TRGO_RESET;
    sMasterConfig.MasterSlaveMode = TIM_MASTERSLAVEMODE_DISABLE;
    HAL_TIMEx_MasterConfigSynchronization(&amp;htim, &amp;sMasterConfig);
    HAL_TIM_Base_Start_IT(&amp;htim);
}
void HAL_TIM_Base_MspInit(TIM_HandleTypeDef* tim_baseHandle)
{
    SET_BIT(RCC-&gt;APB1ENR, 0x1U &lt;&lt; (((reinterpret_cast&lt;unsigned&gt;(tim_baseHandle-&gt;Instance) - APB1PERIPH_BASE)) / 0x400U));
    /* Delay after an RCC peripheral clock enabling */
    __IO uint32_t tmpreg = READ_BIT(RCC-&gt;APB1ENR, 0x1U &lt;&lt; (((reinterpret_cast&lt;unsigned&gt;(tim_baseHandle-&gt;Instance) - APB1PERIPH_BASE)) / 0x400U));
    UNUSED(tmpreg);
    HAL_NVIC_SetPriority(static_cast&lt;IRQn_Type&gt;((reinterpret_cast&lt;unsigned&gt;(tim_baseHandle-&gt;Instance) - APB1PERIPH_BASE) / 0x400U + 28), 0, 0);
    HAL_NVIC_EnableIRQ(static_cast&lt;IRQn_Type&gt;((reinterpret_cast&lt;unsigned&gt;(tim_baseHandle-&gt;Instance) - APB1PERIPH_BASE) / 0x400U + 28));
}


extern &quot;C&quot; void HAL_TIM_PeriodElapsedCallback(TIM_HandleTypeDef *htim)
{
    static uint8_t can1_data[16], can2_data[16];

    if (tasks.counter++, tasks == htim)
    {
        //在这里加入机器人需要执行的任务（update）
    }

    if (tasks.counter % 4 == 0)
    {
        for (auto &amp;motor : can1_motor)motor.Ontimer(can1.data, can1_data);
        for (auto &amp;motor : can2_motor)motor.Ontimer(can2.data, can2_data);
    }

    //can通讯电机输出
    switch (tasks.counter % 5)
    {
        case 0:can1.Transmit(0x200, can1_data); break;
        case 1:can1.Transmit(0x1ff, can1_data + 8); break;
        case 2:can1.Transmit(0x200, can1_data); break;//此处是为了增大底盘输出的频率
        case 3:can2.Transmit(0x200, can2_data); break;
        case 4:can2.Transmit(0x1ff, can2_data + 8); break;
        default:;
    }
}

TIM&amp; TIM::PWMInit(uint32_t channel, float duty, reuse r)
{
    TIM_MasterConfigTypeDef sMasterConfig;
    TIM_OC_InitTypeDef sConfigOC;

    sMasterConfig.MasterOutputTrigger = TIM_TRGO_RESET;
    sMasterConfig.MasterSlaveMode = TIM_MASTERSLAVEMODE_DISABLE;
    HAL_TIMEx_MasterConfigSynchronization(&amp;htim, &amp;sMasterConfig);

    sConfigOC.OCMode = TIM_OCMODE_PWM1;
    sConfigOC.Pulse = static_cast&lt;unsigned&gt;(duty * (htim.Init.Period + 1)) - 1u;
    sConfigOC.OCPolarity = TIM_OCPOLARITY_HIGH;
    sConfigOC.OCFastMode = TIM_OCFAST_DISABLE;
    HAL_TIM_PWM_ConfigChannel(&amp;htim, &amp;sConfigOC, channel);

    this-&gt;MspPostInit(r);
    HAL_TIM_PWM_Start(&amp;htim, channel);
    return *this;
}
void TIM::PWMDuty(const uint32_t channel, const float duty) const
{
    *reinterpret_cast&lt;uint32_t*&gt;(reinterpret_cast&lt;uint8_t*&gt;(htim.Instance-&gt;CCR1) + (channel - TIM_CHANNEL_1)) = (htim.Init.Period + 1)*duty - 1u;
}
void HAL_TIM_PWM_MspInit(TIM_HandleTypeDef* tim_pwmHandle)
{
    __IO uint32_t tmpreg = 0x00U;
    SET_BIT(RCC-&gt;APB1ENR, 0x1U &lt;&lt; (((reinterpret_cast&lt;unsigned&gt;(tim_pwmHandle-&gt;Instance) - APB1PERIPH_BASE)) / 0x400U));
    /* Delay after an RCC peripheral clock enabling */
    tmpreg = READ_BIT(RCC-&gt;APB1ENR, 0x1U &lt;&lt; ((reinterpret_cast&lt;unsigned&gt;(tim_pwmHandle-&gt;Instance - APB1PERIPH_BASE)) / 0x400U));
    UNUSED(tmpreg);
}


void TIM::ICInit(int32_t channel, uint32_t ICPolarity, reuse r)
{
    TIM_MasterConfigTypeDef sMasterConfig;
    TIM_IC_InitTypeDef sConfigIC;
    this-&gt;MspPostInit(r);
    sMasterConfig.MasterOutputTrigger = TIM_TRGO_RESET;
    sMasterConfig.MasterSlaveMode = TIM_MASTERSLAVEMODE_DISABLE;
    HAL_TIMEx_MasterConfigSynchronization(&amp;htim, &amp;sMasterConfig);

    sConfigIC.ICPolarity = ICPolarity;//TIM_INPUTCHANNELPOLARITY_RISING;
    sConfigIC.ICSelection = TIM_ICSELECTION_DIRECTTI;
    sConfigIC.ICPrescaler = TIM_ICPSC_DIV1;
    sConfigIC.ICFilter = 0;
    HAL_TIM_IC_ConfigChannel(&amp;htim, &amp;sConfigIC, channel);
    HAL_TIM_IC_Start_IT(&amp;htim, channel);
}
void HAL_TIM_IC_MspInit(TIM_HandleTypeDef* tim_icHandle)
{
    SET_BIT(RCC-&gt;APB1ENR, 0x1U &lt;&lt; ((reinterpret_cast&lt;unsigned&gt;(tim_icHandle-&gt;Instance - APB1PERIPH_BASE)) / 0x400U));
    /* Delay after an RCC peripheral clock enabling */
    __IO uint32_t tmpreg = READ_BIT(RCC-&gt;APB1ENR, 0x1U &lt;&lt; ((reinterpret_cast&lt;unsigned&gt;(tim_icHandle-&gt;Instance - APB1PERIPH_BASE)) / 0x400U));
    UNUSED(tmpreg);
    HAL_NVIC_SetPriority(static_cast&lt;IRQn_Type&gt;(reinterpret_cast&lt;unsigned&gt;(tim_icHandle-&gt;Instance - APB1PERIPH_BASE) / 0x400U + 28), 0, 0);
    HAL_NVIC_EnableIRQ(static_cast&lt;IRQn_Type&gt;(reinterpret_cast&lt;unsigned&gt;(tim_icHandle-&gt;Instance - APB1PERIPH_BASE) / 0x400U + 28));
}
extern &quot;C&quot; void HAL_TIM_IC_CaptureCallback(TIM_HandleTypeDef *htim)
{
    if (htim-&gt;Instance == TIM4)
    {
        if (htim-&gt;Channel == HAL_TIM_ACTIVE_CHANNEL_1)
        {
            //HAL_GPIO_TogglePin(GPIOG, GPIO_PIN_1);
            if (!(photogate.counter++ &amp; 1))
                ;
            TIM_MasterConfigTypeDef sMasterConfig;
            TIM_IC_InitTypeDef sConfigIC;
            sMasterConfig.MasterOutputTrigger = TIM_TRGO_RESET;
            sMasterConfig.MasterSlaveMode = TIM_MASTERSLAVEMODE_DISABLE;
            HAL_TIMEx_MasterConfigSynchronization(htim, &amp;sMasterConfig);

            sConfigIC.ICPolarity = TIM_INPUTCHANNELPOLARITY_RISING;
            sConfigIC.ICSelection = TIM_ICSELECTION_DIRECTTI;
            sConfigIC.ICPrescaler = TIM_ICPSC_DIV1;
            sConfigIC.ICFilter = 0;
            HAL_TIM_IC_ConfigChannel(htim, &amp;sConfigIC, htim-&gt;Channel);
            HAL_TIM_IC_Start_IT(htim, htim-&gt;Channel);
        }
    }
}
</code></pre>
<p>将我们的项目文件添加如上两个文件，文件中包括TIM定时器的使用和设置，可以更方便我们使用定时器功能来进行机器人复杂功能代码的编写。</p></div>
            </div>
        </div>

        <footer class="col-md-12">
            <hr>
                <p>Copyright © 2021 ASR-Crash, Mike.Han, R.P.Su</p>
            <p>Documentation built with <a href="https://www.mkdocs.org/">MkDocs</a>.</p>
        </footer>
        <script>
            var base_url = "..",
                shortcuts = {"help": 191, "next": 78, "previous": 80, "search": 83};
        </script>
        <script src="../js/base.js" defer></script>
        <script src="../search/main.js" defer></script>

        <div class="modal" id="mkdocs_search_modal" tabindex="-1" role="dialog" aria-labelledby="searchModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h4 class="modal-title" id="searchModalLabel">Search</h4>
                <button type="button" class="close" data-dismiss="modal"><span aria-hidden="true">&times;</span><span class="sr-only">Close</span></button>
            </div>
            <div class="modal-body">
                <p>From here you can search these documents. Enter your search terms below.</p>
                <form>
                    <div class="form-group">
                        <input type="search" class="form-control" placeholder="Search..." id="mkdocs-search-query" title="Type search term here">
                    </div>
                </form>
                <div id="mkdocs-search-results" data-no-results-text="No results found"></div>
            </div>
            <div class="modal-footer">
            </div>
        </div>
    </div>
</div><div class="modal" id="mkdocs_keyboard_modal" tabindex="-1" role="dialog" aria-labelledby="keyboardModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h4 class="modal-title" id="keyboardModalLabel">Keyboard Shortcuts</h4>
                <button type="button" class="close" data-dismiss="modal"><span aria-hidden="true">&times;</span><span class="sr-only">Close</span></button>
            </div>
            <div class="modal-body">
              <table class="table">
                <thead>
                  <tr>
                    <th style="width: 20%;">Keys</th>
                    <th>Action</th>
                  </tr>
                </thead>
                <tbody>
                  <tr>
                    <td class="help shortcut"><kbd>?</kbd></td>
                    <td>Open this help</td>
                  </tr>
                  <tr>
                    <td class="next shortcut"><kbd>n</kbd></td>
                    <td>Next page</td>
                  </tr>
                  <tr>
                    <td class="prev shortcut"><kbd>p</kbd></td>
                    <td>Previous page</td>
                  </tr>
                  <tr>
                    <td class="search shortcut"><kbd>s</kbd></td>
                    <td>Search</td>
                  </tr>
                </tbody>
              </table>
            </div>
            <div class="modal-footer">
            </div>
        </div>
    </div>
</div>

    </body>
</html>
